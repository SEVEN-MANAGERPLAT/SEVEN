# 圣安芈月管理系统后台
## 查询所有员工的提成SQL思路分解
### 1.店长,店长助理,咨询师,咨询顾问流水提成
~~~
SELECT C.EMP_ID,C.AVGFLOW,C.SUMMARY,C.POS_ID,C.FLOW_BIG, C.FLOW_SMALL,C.TUR_ROY,C.SUMMARY * C.TUR_ROY * 0.01 TOTAL
            FROM (
                SELECT A.EMP_ID,A.AVGFLOW,A.SUMMARY,A.POS_ID,B.FLOW_BIG, B.FLOW_SMALL,B.TUR_ROY
                FROM (
                    SELECT FS.EMP_ID,SUM(FS.SUMMARY) / 10000 AVGFLOW,SUM(FS.SUMMARY) SUMMARY,E.POS_ID
                    FROM FLOW_SUMMARY FS
                    LEFT JOIN EMPLOYEE E
                    ON E.EMP_ID = FS.EMP_ID
                    GROUP BY FS.EMP_ID,E.POS_ID
                ) A,(
                    SELECT R.POS_ID, R.FLOW_BIG, R.FLOW_SMALL, R.TUR_ROY
                    FROM ROYALTY R,POSITION P
                    WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 0 AND P.POS_NAME IN ('店长','店长助理','咨询师','咨询顾问')
                ) B
                WHERE A.POS_ID = B.POS_ID
            ) C
            WHERE (C.AVGFLOW >= C.FLOW_SMALL AND C.AVGFLOW &lt; C.FLOW_BIG) OR (C.AVGFLOW >= C.FLOW_SMALL AND C.FLOW_BIG = 0)
----------------------------------------------------------------------------------------------------------------------------------------
SELECT C.EMP_ID, C.POS_ID, C.MOMEY,C.SUMMONEY * C.TUR_ROY * 0.01 SUMMONEY, C.FLOW_BIG, C.FLOW_SMALL, C.TUR_ROY,C.SUMMONEY TOTAL
FROM (
	SELECT A.EMP_ID,A.POS_ID,A.MOMEY,A.SUMMONEY,B.FLOW_BIG, B.FLOW_SMALL, B.TUR_ROY 
	FROM (
		SELECT ACCS.EMP_ID,E.POS_ID,SUM(ACCS.MOMEY)/10000 MOMEY,SUM(ACCS.MOMEY) SUMMONEY
		FROM ACCOUNT_SUMMARY ACCS
		LEFT JOIN EMPLOYEE E
		ON E.EMP_ID = ACCS.EMP_ID
		WHERE (MEM_NUM = '' OR MEM_NUM IS NULL) AND COST_TYPE = 2
		GROUP BY ACCS.EMP_ID,E.POS_ID
	) A,(
		SELECT R.POS_ID, R.FLOW_BIG, R.FLOW_SMALL, R.TUR_ROY 
		FROM ROYALTY R,POSITION P
		WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 0 AND P.POS_NAME IN ('店长','店长助理','咨询师','咨询顾问')
	) B
	WHERE A.POS_ID = B.POS_ID 
) C
WHERE (C.MOMEY >= C.FLOW_SMALL AND C.MOMEY < C.FLOW_BIG ) OR (C.MOMEY >= C.FLOW_SMALL AND C.FLOW_BIG = 0)
~~~
### 2.会员提成
~~~
SELECT EMP_ID,SUM(MONEY) MEM_MONEY 
FROM ROYALTY_SUMMARY
GROUP BY EMP_ID
~~~
### 3.文员退号扣款
~~~
SELECT C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY,C.CLERK_EMP_ID,C.COUNT,C.VIS_ROY TOTAL
FROM (
	SELECT A.POS_ID, A.ORDER_BIG,A.ORDER_SMALL,A.VIS_ROY,B.CLERK_EMP_ID,B.COUNT  
	FROM 
	(
		SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY  
		FROM ROYALTY R,POSITION P
		WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 4 AND P.POS_NAME IN ('文员','咨询顾问')
	) A,
	(
		SELECT A.CLERK_EMP_ID,COUNT(1) COUNT,E.POS_ID
		FROM APPOINTMENT A
		LEFT JOIN EMPLOYEE E
		ON A.CLERK_EMP_ID = E.EMP_ID
		WHERE A.STATE = 0 AND A.CLERK_EMP_ID <> '' AND A.CLERK_EMP_ID IS NOT NULL 
		GROUP BY A.CLERK_EMP_ID,E.POS_ID
	) B
	WHERE A.POS_ID = B.POS_ID 
) C
WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0)
~~~
### 4.咨询顾问退号扣款
~~~
SELECT C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY,C.COUNLOR_EMP_ID,C.COUNT,C.VIS_ROY TOTAL
FROM (
	SELECT A.POS_ID, A.ORDER_BIG,A.ORDER_SMALL,A.VIS_ROY,B.COUNLOR_EMP_ID,B.COUNT  
	FROM 
	(
		SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY  
		FROM ROYALTY R,POSITION P
		WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 4 AND P.POS_NAME IN ('文员','咨询顾问')
	) A,
	(
		SELECT A.COUNLOR_EMP_ID,COUNT(1) COUNT,E.POS_ID
		FROM APPOINTMENT A
		LEFT JOIN EMPLOYEE E
		ON A.COUNLOR_EMP_ID = E.EMP_ID
		WHERE A.STATE = 0 AND A.COUNLOR_EMP_ID <> '' AND A.COUNLOR_EMP_ID IS NOT NULL 
		GROUP BY A.COUNLOR_EMP_ID,E.POS_ID
	) B
	WHERE A.POS_ID = B.POS_ID 
) C
WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0)
~~~
### 5.文员初访提成
~~~
SELECT C.CLERK_ID,C.COUNT,C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY, C.COUNT *  C.VIS_ROY TOTAL
FROM (
	SELECT A.CLERK_ID,A.COUNT,B.POS_ID, B.ORDER_BIG,B.ORDER_SMALL,B.VIS_ROY  
	FROM (
		SELECT ACCS.CLERK_ID,COUNT(1) COUNT,E.POS_ID  
		FROM ACCOUNT_SUMMARY ACCS
		LEFT JOIN EMPLOYEE E
		ON E.EMP_ID = ACCS.CLERK_ID
		WHERE ACCS.VISIT_TYPE = 0 AND ACCS.CLERK_ID IS NOT NULL 
		GROUP BY ACCS.CLERK_ID,E.POS_ID  
	) A,(
		SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY  
		FROM ROYALTY R,POSITION P
		WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 5 AND P.POS_NAME IN ('文员')
	) B
	WHERE A.POS_ID = B.POS_ID 
) C
WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG ) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0)
~~~
### 6.文员再访提成
~~~
SELECT C.CLERK_ID,C.COUNT,C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY, C.COUNT *  C.VIS_ROY TOTAL
FROM (
	SELECT A.CLERK_ID,A.COUNT,B.POS_ID, B.ORDER_BIG,B.ORDER_SMALL,B.VIS_ROY  
	FROM (
		SELECT ACCS.CLERK_ID,COUNT(1) COUNT,E.POS_ID  
		FROM ACCOUNT_SUMMARY ACCS
		LEFT JOIN EMPLOYEE E
		ON E.EMP_ID = ACCS.CLERK_ID
		WHERE ACCS.VISIT_TYPE = 1 AND ACCS.CLERK_ID IS NOT NULL 
		GROUP BY ACCS.CLERK_ID,E.POS_ID  
	) A,(
		SELECT R.POS_ID,R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY  
		FROM ROYALTY R,POSITION P
		WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 6 AND P.POS_NAME IN ('文员')
	) B
	WHERE A.POS_ID = B.POS_ID 
) C
WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG ) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0)
~~~
### 7.店长，助理 退费扣款
~~~
 SELECT C.EMP_ID,C.MOMEY,C.AVGMOMEY,C.FLOW_SMALL,C.FLOW_BIG,C.REFUND_PROPORTION,C.MOMEY * C.REFUND_PROPORTION * 0.01 TOTAL
            FROM (
                SELECT A.EMP_ID,A.MOMEY,A.AVGMOMEY,B.FLOW_SMALL,B.FLOW_BIG,B.REFUND_PROPORTION
                FROM (
                    SELECT E.*,F.MOMEY,F.AVGMOMEY
                    FROM EMPLOYEE E
                    LEFT JOIN (
                        SELECT STORE_ID,SUM(MOMEY) MOMEY,SUM(MOMEY)/10000 AVGMOMEY
                        FROM ACCOUNT_SUMMARY
                        WHERE COST_TYPE = 3
                        GROUP BY STORE_ID
                    ) F ON E.STORE_ID = F.STORE_ID,
                    POSITION P
                    WHERE E.POS_ID = P.POS_ID AND P.POS_NAME IN ('店长','店长助理')
                ) A,
                (
                    SELECT R.POS_ID, R.FLOW_BIG, R.FLOW_SMALL, R.REFUND_PROPORTION
                    FROM ROYALTY R,POSITION P
                    WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 3 AND P.POS_NAME IN ('店长','店长助理')
                ) B
                WHERE A.POS_ID = B.POS_ID
            ) C
            WHERE (C.AVGMOMEY >= C.FLOW_SMALL AND C.AVGMOMEY &lt; C.FLOW_BIG) OR (C.AVGMOMEY >= C.FLOW_SMALL AND C.FLOW_BIG = 0)
~~~
### 8.完整SQL
~~~
SELECT E.EMP_ID, E.EMP_NAME, E.SEX, E.POS_ID, E.CREATE_DATE, E.ISUSE,E.STORE_ID,E.LEADER,P.POS_NAME,E.LEVEL,S.STORE_NAME, D.TOTAL,F.TOTAL,G.TOTAL,H.TOTAL, J.TOTAL,K.TOTAL,M.TOTAL, ISNULL(D.TOTAL,0) + ISNULL(F.TOTAL,0) + ISNULL(G.TOTAL,0) + ISNULL(H.TOTAL,0) ROYALTY, ISNULL(J.TOTAL,0) + ISNULL(K.TOTAL,0) + ISNULL(M.TOTAL,0) REFUND, ISNULL(D.TOTAL,0) + ISNULL(F.TOTAL,0) + ISNULL(G.TOTAL,0) + ISNULL(H.TOTAL,0) - ISNULL(J.TOTAL,0) - ISNULL(K.TOTAL,0) - ISNULL(M.TOTAL,0) BALANCE FROM EMPLOYEE E LEFT JOIN ( SELECT C.EMP_ID,C.AVGFLOW,C.SUMMARY,C.POS_ID,C.FLOW_BIG, C.FLOW_SMALL,C.TUR_ROY,C.SUMMARY * C.TUR_ROY * 0.01 TOTAL FROM ( SELECT A.EMP_ID,A.AVGFLOW,A.SUMMARY,A.POS_ID,B.FLOW_BIG, B.FLOW_SMALL,B.TUR_ROY FROM ( SELECT FS.EMP_ID,SUM(FS.SUMMARY) / 10000 AVGFLOW,SUM(FS.SUMMARY) SUMMARY,E.POS_ID FROM FLOW_SUMMARY FS LEFT JOIN EMPLOYEE E ON E.EMP_ID = FS.EMP_ID WHERE 1 = 1 GROUP BY FS.EMP_ID,E.POS_ID ) A,( SELECT R.POS_ID, R.FLOW_BIG, R.FLOW_SMALL, R.TUR_ROY FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 0 AND P.POS_NAME IN ('店长','店长助理','咨询师','咨询顾问') ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.AVGFLOW >= C.FLOW_SMALL AND C.AVGFLOW < C.FLOW_BIG) OR (C.AVGFLOW >= C.FLOW_SMALL AND C.FLOW_BIG = 0) ) D ON E.EMP_ID = D.EMP_ID LEFT JOIN ( SELECT EMP_ID,SUM(MONEY) TOTAL FROM ROYALTY_SUMMARY WHERE 1 = 1 GROUP BY EMP_ID ) F ON E.EMP_ID = F.EMP_ID LEFT JOIN ( SELECT C.CLERK_ID,C.COUNT,C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY, C.COUNT * C.VIS_ROY TOTAL FROM ( SELECT A.CLERK_ID,A.COUNT,B.POS_ID, B.ORDER_BIG,B.ORDER_SMALL,B.VIS_ROY FROM ( SELECT ACCS.CLERK_ID,COUNT(1) COUNT,E.POS_ID FROM ACCOUNT_SUMMARY ACCS LEFT JOIN EMPLOYEE E ON E.EMP_ID = ACCS.CLERK_ID WHERE ACCS.VISIT_TYPE = 0 AND ACCS.CLERK_ID IS NOT NULL GROUP BY ACCS.CLERK_ID,E.POS_ID ) A,( SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 5 AND P.POS_NAME IN ('文员') ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG ) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0) ) G ON G.CLERK_ID = E.EMP_ID LEFT JOIN ( SELECT C.CLERK_ID,C.COUNT,C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY, C.COUNT * C.VIS_ROY TOTAL FROM ( SELECT A.CLERK_ID,A.COUNT,B.POS_ID, B.ORDER_BIG,B.ORDER_SMALL,B.VIS_ROY FROM ( SELECT ACCS.CLERK_ID,COUNT(1) COUNT,E.POS_ID FROM ACCOUNT_SUMMARY ACCS LEFT JOIN EMPLOYEE E ON E.EMP_ID = ACCS.CLERK_ID WHERE ACCS.VISIT_TYPE = 1 AND ACCS.CLERK_ID IS NOT NULL GROUP BY ACCS.CLERK_ID,E.POS_ID ) A,( SELECT R.POS_ID,R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 6 AND P.POS_NAME IN ('文员') ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG ) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0) ) H ON H.CLERK_ID = E.EMP_ID LEFT JOIN ( SELECT C.EMP_ID,C.MOMEY,C.AVGMOMEY,C.FLOW_SMALL,C.FLOW_BIG,C.REFUND_PROPORTION,C.MOMEY * C.REFUND_PROPORTION * 0.01 TOTAL FROM ( SELECT A.EMP_ID,A.MOMEY,A.AVGMOMEY,B.FLOW_SMALL,B.FLOW_BIG,B.REFUND_PROPORTION FROM ( SELECT E.*,F.MOMEY,F.AVGMOMEY FROM EMPLOYEE E LEFT JOIN ( SELECT STORE_ID,SUM(MOMEY) MOMEY,SUM(MOMEY)/10000 AVGMOMEY FROM ACCOUNT_SUMMARY WHERE COST_TYPE = 3 GROUP BY STORE_ID ) F ON E.STORE_ID = F.STORE_ID, POSITION P WHERE E.POS_ID = P.POS_ID AND P.POS_NAME IN ('店长','店长助理') ) A, ( SELECT R.POS_ID, R.FLOW_BIG, R.FLOW_SMALL, R.REFUND_PROPORTION FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 3 AND P.POS_NAME IN ('店长','店长助理') ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.AVGMOMEY >= C.FLOW_SMALL AND C.AVGMOMEY < C.FLOW_BIG) OR (C.AVGMOMEY >= C.FLOW_SMALL AND C.FLOW_BIG = 0) ) J ON J.EMP_ID = E.EMP_ID LEFT JOIN ( SELECT C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY,C.CLERK_EMP_ID,C.COUNT,C.VIS_ROY TOTAL FROM ( SELECT A.POS_ID, A.ORDER_BIG,A.ORDER_SMALL,A.VIS_ROY,B.CLERK_EMP_ID,B.COUNT FROM ( SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 4 AND P.POS_NAME IN ('文员','咨询顾问') ) A, ( SELECT A.CLERK_EMP_ID,COUNT(1) COUNT,E.POS_ID FROM APPOINTMENT A LEFT JOIN EMPLOYEE E ON A.CLERK_EMP_ID = E.EMP_ID WHERE A.STATE = 0 AND A.CLERK_EMP_ID <> '' AND A.CLERK_EMP_ID IS NOT NULL GROUP BY A.CLERK_EMP_ID,E.POS_ID ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0) ) K ON K.CLERK_EMP_ID = E.EMP_ID LEFT JOIN ( SELECT C.POS_ID, C.ORDER_BIG,C.ORDER_SMALL,C.VIS_ROY,C.COUNLOR_EMP_ID,C.COUNT,C.VIS_ROY TOTAL FROM ( SELECT A.POS_ID, A.ORDER_BIG,A.ORDER_SMALL,A.VIS_ROY,B.COUNLOR_EMP_ID,B.COUNT FROM ( SELECT R.POS_ID, R.ORDER_BIG,R.ORDER_SMALL,R.VIS_ROY FROM ROYALTY R,POSITION P WHERE R.POS_ID = P.POS_ID AND R.CONSUME_TYPE = 4 AND P.POS_NAME IN ('文员','咨询顾问') ) A, ( SELECT A.COUNLOR_EMP_ID,COUNT(1) COUNT,E.POS_ID FROM APPOINTMENT A LEFT JOIN EMPLOYEE E ON A.COUNLOR_EMP_ID = E.EMP_ID WHERE A.STATE = 0 AND A.COUNLOR_EMP_ID <> '' AND A.COUNLOR_EMP_ID IS NOT NULL GROUP BY A.COUNLOR_EMP_ID,E.POS_ID ) B WHERE A.POS_ID = B.POS_ID ) C WHERE (C.COUNT >= C.ORDER_SMALL AND C.COUNT < C.ORDER_BIG) OR (C.COUNT >= C.ORDER_SMALL AND C.ORDER_BIG = 0) ) M ON M.COUNLOR_EMP_ID = E.EMP_ID LEFT JOIN POSITION P ON P.POS_ID = E.POS_ID LEFT JOIN STORE S ON E.STORE_ID = S.STORE_ID WHERE 1 = 1
~~~

